#! /bin/bash -l
#SBATCH --export=NONE
#SBATCH -M galaxy
#SBATCH -p workq
#SBATCH --account=mwasci
#SBATCH --time=12:00:00
#SBATCH --nodes=1

source /group/mwa/software/module-reset.sh
module use /group/mwa/software/modulefiles
module load MWA_Tools/mwa-sci
module list

set -x

# begin timestamps
{
#memory in GB
mem=$( echo "$SLURM_MEM_PER_NODE / 1000" | bc )

calibrator=CALIBRATOR
base=BASEDIR
datadir="${base}/processing"
modeldir="/group/mwa/software/mwa-reduce/mwa-reduce/models"
obsnum=OBSNUM


# start
calmodel=`basename ${modeldir}/model-${calibrator}-*_withalpha.txt`
echo "using calibrator model : ${calmodel}"

# check that the model exists
if [[ ! -e ${modeldir}/${calmodel} ]]
then
  echo "Cannot find calibrator model for ${calibrator}"
  echo "File: ${modeldir}/${calmodel} not found"
  exit 1
fi

cd ${datadir}/${obsnum}

# pythonpath hack
ln -s /group/mwa/software/mwapy/master/galaxy/lib/python2.7/site-packages/mwapy .

solutions=${obsnum}_${calmodel%%.txt}_solutions_initial.bin

# calibrate
calibrate -absmem ${mem} -m ${modeldir}/${calmodel} -minuv 20 -maxuv 2700 ${obsnum}.ms ${solutions}

# plot calibration solutions
aocal_plot.py --refant=127 --amp_max=2 ${solutions}

# apply calibration
applysolutions ${obsnum}.ms ${solutions}

# run aoflagger
# default is to work on the corrected data column
aoflagger ${obsnum}.ms 

solutions=${obsnum}_${calmodel%%.txt}_solutions.bin
# calibrate again!
calibrate -absmem ${mem} -m ${modeldir}/${calmodel} -minuv 20 -maxuv 2700 ${obsnum}.ms ${solutions}

#plot again
aocal_plot.py --refant=127 --amp_max=2 ${solutions}

# apply calibration again
applysolutions ${obsnum}.ms ${solutions}

# delete the symlink
rm mwapy

} 2> >(awk '{print strftime("%F %T")";",$0; fflush()}' >&2) > >(awk '{print strftime("%F %T")";",$0; fflush()}')
