#! /bin/bash -l
#SBATCH --export=NONE
#SBATCH -M zeus
#SBATCH -p copyq
#SBATCH --account=courses01
#SBATCH --time=12:00:00
#SBATCH --nodes=1

base=BASEDIR
datadir=${base}/processing
obsnum=OBSNUM
tres=TRES
fres=FRES
csvfile="${obsnum}_dl.csv"


# setup a clean environment
source /group/mwa/software/module-reset.sh
module use /group/mwa/software/modulefiles
module load mwapy
module load manta-ray-client
module list

set -x

{
# check that the ASVO environment variables are set
if [[ -z ${ASVO_USER} ]]
then
    echo "Error, ASVO_USER not set"
    echo "Cannot use client"
    exit 1
fi


# start task
mkdir -p ${datadir}/${obsnum}
cd ${datadir}/${obsnum}

# encode the conversion options into a csv file
echo "obs_id=${obsnum}, job_type=c, timeres=${tres}, freqres=${fres}, edgewidth=80, conversion=ms, allowmissing=true, flagdcchannels=true, usepcentre=true" > ${csvfile}

outfile="${obsnum}_ms.zip"
msfile="${obsnum}.ms"

if [[ -e "${outfile}" ]]
then
    echo "${outfile} exists, not downloading again"
elif [[ -e "${msfile}" ]]
then
    echo "${msfile} exists, not downloading again"
else
    mwa_client --csv=${csvfile} --dir=${datadir}/${obsnum}
fi

# unzip the file if it exists
if [[ -e "${outfile}" ]]
then
    unzip -n ${outfile}

    rm ${outfile}
fi
} 2> >(awk '{print strftime("%F %T")";",$0; fflush()}' >&2) > >(awk '{print strftime("%F %T")";",$0; fflush()}')
