#! /bin/bash -l
#SBATCH --export=NONE
#SBATCH -M galaxy
#SBATCH -p workq
#SBATCH --account=mwasci
#SBATCH --time=06:00:00
#SBATCH --nodes=1


function test_fail {
if [[ $1 != 0 ]]
then
    cd ${base}
    python bin/track_task.py fail --jobid=${SLURM_JOBID} --finish_time=`date +%s`
    exit $1
fi
}

# automatically set the right number of corse
# maybe leaving -d blank will do this ...
if [[ $SLURM_JOB_PARTITION -eq "gpuq" ]]
then
    cores=8
else #if [[ $SLURM_JOB_PARTITION -eq "workq" ]]
    cores=20
fi

base=BASEDIR
datadir="${base}/processing"
obsnum=OBSNUM
flagfile=FLAGFILE

# start
cd ${base}
python bin/track_task.py start --jobid=${SLURM_JOBID} --start_time=`date +%s`


cd ${datadir}/${obsnum}

if [[ ! -z ${flagfile} ]]
then
    flagantennae ${obsnum}.ms $( cat ${flagfile} )
    test_fail $?
fi

# run aoflagger
# default is to work on the corrected data column
aoflagger ${obsnum$}.ms 
test_fail $?

# delete the symlinks and temp directory
rm -r mwapy

cd ${base}
python bin/track_task.py finish --jobid=${SLURM_JOBID} --finish_time=`date +%s`

