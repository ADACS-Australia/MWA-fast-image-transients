#! /bin/bash -l
#SBATCH -M zeus
#SBATCH -p copyq
#SBATCH --account=mwasci
#SBATCH --time=01:00:00
#SBATCH --nodes=1
#SBATCH --mem=32gb

#aprun='aprun -n 1 -d 8 -b'
base=BASEDIR
datadir=${base}/processing

obsnum=OBSNUM

# start download
cd ${base}
python bin/track_task.py start --jobid=${SLURM_JOBID} --start_time=`date +%s`

cd ${datadir}
obsdownload.py -o ${obsnum}

res=$?

# check how many files we expect to see
nfiles=`sqlite3 ${base}/db/MWA-GRB.sqlite "SELECT nfiles FROM observation WHERE obs_id=${obsnum};"`

# if we don't have this many files then we have a bad result.
if [[ nfiles -eq `ls ${obnum}*.{fits,mwaf} | wc` ]]
then
  res=1
fi

cd ${base}
# finish download
if [[ ${res} -eq 0 ]]
then
  python bin/track_task.py finish --jobid=${SLURM_JOBID} --finish_time=`date +%s`
else
  python bin/track_task.py fail --jobid=${SLURM_JOBID} --finish_time=`date +%s`
fi
