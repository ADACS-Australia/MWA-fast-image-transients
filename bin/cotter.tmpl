#! /bin/bash -l
#SBATCH -M galaxy
#SBATCH -p workq
#SBATCH --account=mwasci
#SBATCH --time=04:00:00
#SBATCH --nodes=1
#SBATCH --mem=32gb

aprun='aprun -n 1 -d 20 -b'
base=BASEDIR
datadir=${base}/processing

obsnum=OBSNUM
tres=TRES
fres=FRES

# start task
cd ${base}
python bin/track_task.py start --jobid=${SLURM_JOBID} --start_time=`date +%s`

zipflag="${obsnum}_flags.zip"
if [[ -e ${zipflag} ]]
then
    unzip ${zipflag}
    flagfiles='-flagfiles ${obsnum}_%%.mwaf'
else
    flagfiles=''
fi

cd ${datadir}/${obsnum}
$aprun cotter ${flagfiles} -timeres ${tres} -freqres ${fres} \
             -edgewidth 80 -m ${obsnum}_metafits_ppds.fits -o ${obsnum}.ms *gpubox*.fits 

res=$?

if [[ ${res} -eq 0 ]] && [[ -d OBSNUM.ms ]]
then 
     rm *gpubox*fits *.zip *.mwaf ${obsnum}_metafits_ppds.fits
fi

# finish job
cd ${base}
# finish download
if [[ ${res} -eq 0 ]]
then
  python bin/track_task.py finish --jobid=${SLURM_JOBID} --finish_time=`date +%s`
else
  python bin/track_task.py fail --jobid=${SLURM_JOBID} --finish_time=`date +%s`
fi
