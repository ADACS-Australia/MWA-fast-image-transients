#! /bin/bash -l
#SBATCH --account=mwasci
#SBATCH --partition=workq
#SBATCH --time=10:00:00
#SBATCH --nodes=1


# automatically set the right number of corse
# maybe leaving -d blank will do this ...
if [[ $SLURM_JOB_PARTITION -eq "gpuq" ]]
then
    cores=8
else #if [[ $SLURM_JOB_PARTITION -eq "workq" ]]
    cores=20
fi
aprun='aprun -n 1 -d ${cores} -b'

base=BASEDIR
datadir=${base}/processing

obsnum=OBSNUM

xxfiles=`ls ${datadir}/${obsnum}/${obsnum}*hr*XX-image.fits`
xout="${base}/done/${obsnum}_stack_xx.fits"
yyfiles=`ls ${datadir}/${obsnum}/${obsnum}*hr*YY-image.fits`
yout="${base}/done/${obsnum}_stack_yy.fits"

# start download
cd ${base}
python bin/track_task.py start --jobid=${SLURM_JOBID} --start_time=`date +%s`

# stack the xx and yy images separately
$aprun python bin/imstack.py --files=${xxfiles} --out=${xout}
$aprun python bin/imstack.py --files=${yyfiles} --out=${yout}
# form median images
# TODO:!

res=$?
cd ${base}
# finish download
if [[ ${res} -eq 0 ]]
then
  python bin/track_task.py finish --jobid=${SLURM_JOBID} --finish_time=`date +%s`
else
  python bin/track_task.py fail --jobid=${SLURM_JOBID} --finish_time=`date +%s`
fi
